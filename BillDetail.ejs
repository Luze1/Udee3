<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏´‡πâ‡∏≠‡∏á <%= contract.room_id %></title>
    <link rel="stylesheet" href="/style/BillDetail.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <!-- Boxicons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/style/navOwner.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </head>
  <body style="background-color: #d4e6e6">
    <%- include('navOwner.html') %>
    <div id="main-content">
      <div class="container">
        <div class="header-section">
          <h1>‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h1>
          <h2>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</h2>
          <span class="update-status">
            ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó
            <span
              class="status-indicator <%= contract.bill_status ? contract.bill_status.replace(/\s/g, '-').toLowerCase() : 'no-data' %>"
            >
              <%= contract.bill_status || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' %>
            </span>
          </span>
          <h2 class="main-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏•</h2>

          <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
          <form id="addExpenseForm">
            <div>
              <label>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ö‡∏≤‡∏ó): </label>
              <input
                type="number"
                id="additional_expense"
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"
              />
            </div>
          </form>

          <!-- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü -->
          <form id="recordUsageForm">
            <label for="month">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: December 2025):</label>
            <input
              type="text"
              id="month"
              name="month"
              placeholder=""
              required
            />

            <label for="waterUnits">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡πâ‡∏≥:</label>
            <input
              type="number"
              id="waterUnits"
              name="waterUnits"
              min="0"
              required
            />

            <label for="electricUnits">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü:</label>
            <input
              type="number"
              id="electricUnits"
              name="electricUnits"
              min="0"
              required
            />
          </form>

          <!-- ‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏• -->
          <button type="button" id="sendBillBtn">‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•</button>
        </div>

        <div class="bill-details">
          <% if (contract && (contract.room_id || contract.bill_status)) { %>
          <div class="tenant-info">
            <h2 class="main-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤:</h2>
            <p>
              <strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤:</strong> <%= contract.firstName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
              %> <%= contract.lastName || '' %>
            </p>
            <p>
              <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏¥‡∏•:</strong>
              <span
                class="status-indicator <%= contract.bill_status ? (contract.bill_status === '1' ? 'paid' : contract.bill_status === '2' ? 'pending-review' : contract.bill_status === '0' ? 'unpaid' : contract.bill_status === '3' ? 'incomplete' : 'no-data') : 'no-data' %>"
              >
                <%= contract.bill_status === '1' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' :
                contract.bill_status === '2' ? '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' :
                contract.bill_status === '0' ? '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞' : contract.bill_status
                === '3' ? '‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' %>
              </span>
            </p>
            <p>
              <strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> <%= contract.telephone ||
              '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' %>
            </p>
          </div>

          <h2 class="main-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</h2>
          <table>
            <thead>
              <tr>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <%= billMonth %></td>
                <td class="amount">
                  <%= (contract.rent_fee || 0).toLocaleString() %>
                </td>
              </tr>
              <tr>
                <td>
                  ‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <%= billMonth %> (<%=
                  waterUnits.toLocaleString() %> ‡∏´‡∏ô‡πà‡∏ß‡∏¢ x <%=
                  (contract.water_per_unit || 0).toLocaleString() %> ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢)
                </td>
                <td class="amount"><%= waterBill.toLocaleString() %></td>
              </tr>
              <tr>
                <td>
                  ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <%= billMonth %> (<%=
                  electricUnits.toLocaleString() %> ‡∏´‡∏ô‡πà‡∏ß‡∏¢ x <%=
                  (contract.electric_per_unit || 0).toLocaleString() %>
                  ‡∏ö‡∏≤‡∏ó/‡∏´‡∏ô‡πà‡∏ß‡∏¢)
                </td>
                <td class="amount"><%= electricBill.toLocaleString() %></td>
              </tr>
              <tr>
                <td>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</td>
                <td class="amount">
                  <%= (additionalExpenses || 0).toLocaleString() %>
                </td>
              </tr>
              <tr>
                <td>‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö</td>
                <td class="amount"><%= (fine || 0).toLocaleString() %></td>
              </tr>
              <tr>
                <td style="text-align: right"><strong>‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î</strong></td>
                <td class="amount">
                  <strong><%= total.toLocaleString() %></strong>
                </td>
              </tr>
            </tbody>
          </table>

          <% if (contract.bill_status === '‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå') { %>
          <p style="color: red">
            * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
          </p>
          <form id="billForm">
            <label for="water">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡πâ‡∏≥:</label>
            <input type="number" id="water" name="water" min="0" required />
            <label for="electric">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü:</label>
            <input
              type="number"
              id="electric"
              name="electric"
              min="0"
              required
            />
            <button type="button" id="saveButton" class="save-button active">
              ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü
            </button>
          </form>
          <% } %>

          <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à -->
          <h2 class="main-title">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</h2>
          <% if (receiptPic) { %>
          <img
            src="data:image/jpeg;base64,<%= receiptPic.toString('base64') %>"
            alt="Receipt"
            style="max-width: 300px; max-height: 300px"
          />
          <% } else { %>
          <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</p>
          <% } %> <% } else { %>
          <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>
          <% } %>
        </div>

        <% if (contract && (contract.room_id || contract.bill_status)) { %>
        <div class="button-section">
          <% if (contract.bill_status === '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß') { %>
          <a
            href="javascript:void(0)"
            class="action-button"
            onclick="cancelPayment('<%= contract.room_id %>')"
            >‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</a
          >
          <% } else if (contract.bill_status === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') { %>
          <a
            href="javascript:void(0)"
            class="action-button"
            onclick="makePayment('<%= contract.room_id %>')"
            >‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a
          >
          <% } else if (contract.bill_status === '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') { %>
          <a
            href="javascript:void(0)"
            class="action-button"
            onclick="confirmPayment('<%= contract.room_id %>')"
            >‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</a
          >
          <% } else if (contract.bill_status !== '‡∏ö‡∏¥‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå' &&
          contract.bill_status !== '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô' && contract.bill_status !==
          '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•') { %>
          <a
            href="/api/make-payment?room_id=<%= room_id %>"
            class="btn btn-primary"
            >‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á</a
          >
          <% } %>
        </div>
        <% } %>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const saveButton = document.getElementById("saveButton");

        saveButton?.addEventListener("click", function () {
          const waterUnits = document.getElementById("water").value;
          const electricUnits = document.getElementById("electric").value;

          if (!waterUnits || !electricUnits) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
            return;
          }

          axios
            .post("/api/save-bill", {
              room_id: "<%= contract.room_id %>",
              water_units: waterUnits,
              electric_units: electricUnits,
            })
            .then((response) => {
              alert(response.data.message);
              window.location.reload();
            })
            .catch((error) => {
              console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥/‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü");
            });
        });
      });
      document
        .getElementById("sendBillBtn")
        .addEventListener("click", function () {
          const roomId = "<%= contract.room_id %>"; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å EJS
          const month = document.getElementById("month").value.trim();
          const additionalExpense =
            parseFloat(document.getElementById("additional_expense").value) ||
            0;
          const waterUnits =
            parseFloat(document.getElementById("waterUnits").value) || 0;
          const electricUnits =
            parseFloat(document.getElementById("electricUnits").value) || 0;

          if (!month) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô");
            return;
          }

          axios
            .post("/api/send-bill", {
              room_id: roomId,
              month,
              additional_expense: additionalExpense,
              water_units: waterUnits,
              electric_units: electricUnits,
            })
            .then((response) => {
              alert(response.data.message);
              window.location.reload();
            })
            .catch((error) => {
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•");
              console.error(error);
            });
        });

      function makePayment(roomId) {
        axios
          .post("/api/make-payment", { room_id: roomId })
          .then((response) => {
            alert(response.data.message);
            window.location.reload();
          })
          .catch((error) => {
            console.error("‚ùå Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
          });
      }

      function confirmPayment(roomId) {
        axios
          .post("/api/make-payment", { room_id: roomId })
          .then((response) => {
            alert(response.data.message);
            window.location.reload();
          })
          .catch((error) => {
            console.error("‚ùå Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô");
          });
      }

      function cancelPayment(roomId) {
        axios
          .post("/api/cancel-payment", { room_id: roomId })
          .then((response) => {
            alert(response.data.message);
            window.location.reload();
          })
          .catch((error) => {
            console.error("‚ùå Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞");
          });
      }

      function sendBill() {
        document.getElementById("sendBillBtn").disabled = true;

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ input ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
        const monthInput = document.getElementById("month");
        const waterInput = document.getElementById("waterUnits");
        const electricInput = document.getElementById("electricUnits");
        const additionalInput = document.getElementById("additional_Expense");

        if (!monthInput || !waterInput || !electricInput || !additionalInput) {
          console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Input ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö id ‡πÉ‡∏ô HTML");
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö input ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£");
          document.getElementById("sendBillBtn").disabled = false;
          return;
        }

        const room_id = "<%= contract.room_id %>";
        const month = monthInput.value.trim();
        const water_units = parseFloat(waterInput.value) || 0;
        const electric_units = parseFloat(electricInput.value) || 0;
        const additional_expense = parseFloat(additionalInput.value) || 0;

        if (!month) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•");
          document.getElementById("sendBillBtn").disabled = false;
          return;
        }

        console.log("üîπ Sending request:", {
          room_id,
          month,
          water_units,
          electric_units,
          additional_expense,
        });

        axios
          .post("/api/send-bill", {
            room_id,
            month,
            water_units,
            electric_units,
            additional_expense,
          })
          .then((response) => {
            alert(response.data.message);
            window.location.reload();
          })
          .catch((error) => {
            console.error("‚ùå Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ö‡∏¥‡∏•");
          })
          .finally(() => {
            document.getElementById("sendBillBtn").disabled = false;
          });
      }
    </script>
  </body>
</html>
